---
- name: Deploy Backend App
  hosts: backend
  become: yes
  vars:
    backend_app_dir: /home/ec2-user/backend-app
    node_version: 20
    db_host: "10.0.4.82"
    db_name: "backenddb"
    db_user: "backenduser"
    db_password: "backendpass123"

  tasks:
    - name: Install required tools
      yum:
        name:
          - curl
          - gcc
          - make
        state: present

    - name: Install Node.js 20 repo
      ansible.builtin.shell: |
        curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
      args:
        warn: false

    - name: Install Node.js
      yum:
        name: nodejs
        state: present

    - name: Ensure backend app directory exists
      file:
        path: "{{ backend_app_dir }}"
        state: directory

    - name: Copy backend app files from control node
      copy:
        src: "../backend-app/"
        dest: "{{ backend_app_dir }}/"
        owner: ec2-user
        group: ec2-user
        mode: 0755

    - name: Install backend app dependencies
      npm:
        path: "{{ backend_app_dir }}"
        production: yes

    - name: Configure backend app environment variables
      ansible.builtin.copy:
        dest: "{{ backend_app_dir }}/.env"
        content: |
          DB_HOST={{ db_host }}
          DB_NAME={{ db_name }}
          DB_USER={{ db_user }}
          DB_PASSWORD={{ db_password }}
          DB_PORT=5432
        owner: ec2-user
        group: ec2-user
        mode: 0600

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Start backend app with PM2
      ansible.builtin.shell: |
        pm2 start index.js --name backend --env production
        pm2 save
      args:
        chdir: "{{ backend_app_dir }}"
